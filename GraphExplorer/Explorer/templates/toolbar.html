<style>
    .toolbar_container{
        width: 100%;
        height: fit-content;
        display: flex;
        gap: 10px;
        padding: 10px;
    }

    .crudButton{
        padding: 5px;
        background-color: rgba(255, 255, 255, 0.205);
        border: solid black 2px;
        border-radius: 15px;
    }
</style>
<div class="toolbar_container">
    <button id="toolbar-create-vertex" class="crudButton" onclick="document.getElementById('vertexDialog').showModal()">Create Vertex</button>
    <button id="toolbar-edit" class="crudButton" onclick="openVertexEditDialog(selectedNode)">Edit</button>
    <button id="toolbar-delete" class="crudButton" onclick="deleteSelected()">Delete</button>


    <div class="toolbar_container">
        <label>Data Source Plugin:
            <select id="pluginSelect"></select>
        </label>
        <button id="toolbar-load-graph" class="crudButton">Load Graph</button>
    </div>

    <dialog id="loadGraphDialog">
        <h3>Load Graph</h3>
        <form id="loadGraphForm">
            <div id="pluginInputs"></div> <!--dynamic inputs-->
            <menu>
                <button type="reset" onclick="this.closest('dialog').close()">Cancel</button>
                <button type="submit">Load</button>
            </menu>
        </form>
    </dialog>


    <dialog id="vertexDialog">
        {% include 'crud/vertex_create.html' %}
    </dialog>
    
    <dialog id="vertexEditDialog">
        {% include 'crud/vertex_edit.html' %}
    </dialog>

    <script>
        /*fetching all data source plugins*/
        async function fetchPlugins() {
            const res = await fetch('get-plugins/');
            const data = await res.json();
            const select = document.getElementById('pluginSelect');
            select.innerHTML = '';
            data.plugins.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                select.appendChild(opt);
            });
        }

        fetchPlugins();




        document.getElementById('toolbar-load-graph').addEventListener('click', async () => {
            const pluginName = document.getElementById('pluginSelect').value;
            const res = await fetch(`/plugin-fields/?plugin=${pluginName}`);
            const data = await res.json();

            const container = document.getElementById('pluginInputs');
            container.innerHTML = '';

            data.fields.forEach(f => {
                const label = document.createElement('label');
                label.textContent = f + ': ';
                let input;

                // simple heuristics for field type
                if (f.includes("file")) {
                    input = document.createElement('input');
                    input.type = 'file';
                    input.name = f;
                    input.required = true;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.name = f;
                    input.required = true;
                }

                label.appendChild(input);
                container.appendChild(label);
                container.appendChild(document.createElement('br'));
            });

            document.getElementById('loadGraphDialog').showModal();
        });


        document.getElementById('loadGraphForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const pluginName = document.getElementById('pluginSelect').value;
            const formData = new FormData(this);
            formData.append('plugin', pluginName);

            const res = await fetch('/load-graph/', {
                method: 'POST',
                body: formData
            });
            const result = await res.json();

            if(res.ok){
                this.closest('dialog').close();
                document.dispatchEvent(new CustomEvent("graphStructureChanged"));
            } else {
                alert("Failed to load graph: " + result.output);
            }
        });

/*document.getElementById('toolbar-load-graph').addEventListener('click', () => {
            fetch('/get-plugins/')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('pluginSelect');
                    select.innerHTML = '';
                    data.plugins.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p;
                        opt.textContent = p;
                        select.appendChild(opt);
                    });
                    document.getElementById('loadGraphDialog').showModal();
                });
        });

        document.getElementById('loadGraphForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const plugin = document.getElementById('pluginSelect').value;
            const fileInput = document.getElementById('dataFile');
            const file = fileInput.files[0];

            const formData = new FormData();
            formData.append('plugin', plugin);
            formData.append('file', file);

            const res = await fetch('/load-graph/', {
                method: 'POST',
                body: formData
            });

            const result = await res.json();
            if(res.ok){
                this.closest('dialog').close();
                document.dispatchEvent(new CustomEvent("graphStructureChanged"));
            } else {
                alert("Failed to load graph: " + result.output);
            }
        });*/



        let selectedNode = null;
        let createVertexBtn = document.getElementById("toolbar-create-vertex")
        let editBtn = document.getElementById("toolbar-edit")
        let deleteBtn = document.getElementById("toolbar-delete")

        function nodeSelected(){
            editBtn.disabled = false;
            deleteBtn.disabled = false;
        }

        function nodeDeselected(){
            editBtn.disabled = true;
            deleteBtn.disabled = true;
        }

        function deleteSelected(){
            if(selectedNode){
                fetch("api/vertex/delete/", {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'id': selectedNode.id
                    })
                })
                .then(res => {
                    document.dispatchEvent(new CustomEvent("nodeSelectionChanged"))
                    document.dispatchEvent(new CustomEvent("graphStructureChanged"));
                })
            }
        }

        function fetchSelectedNode(){
            fetch("select/", {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(res => {
                if (res.ok){
                    return res.json()
                }
                else{
                    throw new Error("Bad request")
                }
            })
            .then(data => {
                selectedNode = data.node
                nodeSelected()
            })
            .catch( () => {
                    selectedNode = null
                nodeDeselected()
            })
        }

        document.addEventListener("nodeSelectionChanged", fetchSelectedNode)
        fetchSelectedNode()
    </script>
</div>